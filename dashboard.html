<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Budget Tracker</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body { margin: 0; font-family: Arial, sans-serif; background: #f3f3f3; }

/* Header */
.header {
    background: #0b7dda;
    color: white;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
}

nav ul { list-style: none; display: flex; gap: 25px; margin: 0; padding: 0; }
nav ul li {
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: white;
}
nav ul li:hover { text-decoration: underline; }

/* Card */
.hero-card {
    background: white;
    padding: 25px;
    margin-top: 25px;
    text-align: center;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
}

/* Summary Boxes */
.summary { display: flex; justify-content: space-between; margin: 25px 0; flex-wrap: wrap; }
.box {
    flex: 1;
    padding: 25px;
    margin: 10px;
    text-align: center;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    font-size: 20px;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
}
.income { background-color: #04AA6D; }
.expense { background-color: #f44336; }
.balance { background-color: #0b7dda; }

/* Popup */
.popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); }
.popup-content {
    background: white; width: 370px;
    margin: 7% auto; padding: 25px;
    border-radius: 12px; text-align: center;
    box-shadow: 0 0 18px rgba(0,0,0,.25);
}

.popup-content input {
    width: 90%; padding: 12px; margin: 8px 0 2px 0;
    border-radius: 8px; border: 1px solid #0b7dda;
    font-size: 15px;
}

button {
    padding: 10px 14px; border: none; cursor: pointer; 
    font-weight: 600; margin-top: 12px; border-radius: 6px;
}
.table-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    margin-bottom: 10px;
}

.table-controls {
    background: white;
    padding: 12px 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 15px 20px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.left-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.rows-dropdown, .sort-dropdown, .search-by {
    padding: 7px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
}

.search-container {
    display: flex;
    align-items: center;
    background: #f2f2f2;
    padding: 6px 10px;
    border-radius: 6px;
    gap: 6px;
}

.search-input {
    border: none;
    background: transparent;
    outline: none;
    width: 180px;
}

.right-controls {
    display: flex;
    gap: 10px;
}


.icon-btn {
    background: white;
    border: 1px solid #ddd;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: 0.3s;
}

.icon-btn:hover {
    background: #007bff;
    color: white;
    border-color: transparent;
}
#data-table.grid-view td {
    display: block;
    width: 100%;
    padding: 8px 0;
    border-bottom: 1px solid #e2e2e2;
}
/* Modal overlay */
.filter-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}
.error-msg {
    color: red;
    text-align: left;
    font-size: 13px;
    margin-top: 2px;
    display: block;
}

/* Modal content */
.filter-modal-content {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 350px;
    background: white;
    padding: 25px 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.25);
    z-index: 1001;
    font-family: Arial, sans-serif;
}

.filter-modal-content h3 {
    margin-top: 0; 
    margin-bottom: 15px;
    text-align: center;
    color: #0b7dda;
}

.filter-modal-content label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
    color: #333;
}

.filter-modal-content input {
    width: 90%;
    padding: 8px 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
}

.filter-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}

.filter-buttons button {
    padding: 8px 14px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

#applyFilterBtn { background: #0b7dda; color: white; }
#resetFilterBtn { background: #f44336; color: white; }

.detail-row td {
    font-size: 14px;
    color: #333;
    background: #f0f8ff;
    border-top: 1px solid #ddd;
}

/* Table */
.transactionTableContainer {
    margin-top: 25px; overflow-x: auto;
    background: white; padding: 18px;
    border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.1);
}

.transactionTable { width: 100%; border-collapse: collapse; }
.transactionTable th {
    background-color: #0b7dda; color: white;
    padding: 14px; text-transform: uppercase;
}
.transactionTable td { padding: 12px; text-align: center; }

.transactionTable tbody tr:nth-child(even) { background: #eaf7ff; }
.transactionTable tbody tr:hover { background: #d6f5e1; }

.amount-positive { color: #04AA6D; font-weight: bold; }
.amount-negative { color: #f44336; font-weight: bold; }

.edit-btn { background: #0b7dda; color: white; padding: 6px 10px; border-radius: 5px; }
.delete-btn { background: #f44336; color: white; padding: 6px 10px; border-radius: 5px; }

/* Profile */
.profile-img { width:100px; height:100px; border-radius:50%; border:3px solid #04AA6D; object-fit:cover; }

.eye-icon { position: absolute; right: 38px; margin-top: 20px; cursor: pointer; color:black }
/* ===== Transaction Details Popup ===== */
#transactionDetailsPopup {
    display: none; /* keep popup hidden by default */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1002;
}

#transactionDetailsPopup .popup-content {
    width: 400px;
    max-width: 90%;
    background: #ffffff;
    margin: 8% auto;
    padding: 30px 25px;
    border-radius: 12px;
    text-align: left;
    box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    position: relative;
}

#transactionDetailsPopup h3 {
    text-align: center;
    color: #0b7dda;
    font-size: 22px;
    margin-bottom: 20px;
    font-weight: 600;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 8px;
}

#transactionDetailsPopup p {
    font-size: 15px;
    margin: 10px 0;
    line-height: 1.5;
}

#transactionDetailsPopup p strong {
    color: #0b7dda;
    width: 100px;
    display: inline-block;
}

#transactionDetailsPopup button {
    width: 100%;
    padding: 12px 0;
    background: #f44336;
    color: white;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    margin-top: 20px;
    cursor: pointer;
    transition: 0.3s;
}

#transactionDetailsPopup button:hover {
    background: #c12c2c;
}

/* Responsive */
@media(max-width: 480px) {
    #transactionDetailsPopup .popup-content {
        padding: 20px 15px;
    }
    #transactionDetailsPopup h3 {
        font-size: 20px;
    }
    #transactionDetailsPopup p {
        font-size: 14px;
    }
}


/* Responsive */
@media(max-width: 768px) {
.summary { flex-direction: column; }
}
</style>
</head>


<body>

<header class="header">
    <h2>Budget Tracker</h2>
    <nav>
        <ul>
            <li id="dashboardBtn">Dashboard</li>
            <li id="profileBtn">My Profile</li>
            <li id="logoutBtn">Logout</li>
        </ul>
    </nav>
</header>

<div class="container">

    <div class="hero-card">
        <h2>Welcome Back, <span id="welcomeUser"></span>!</h2>
    </div>

    <div class="summary">
        <div class="box income"><div>Income</div><span id="totalIncome">0</span></div>
        <div class="box expense"><div>Expense</div><span id="totalExpense">0</span></div>
        <div class="box balance"><div>Balance</div><span id="balance">0</span></div>
    </div>

    <button id="addTransactionBtn" style="background:#04AA6D;color:white;">Add Transaction</button>
<section class="table-controls">
    <div class="left-controls">
         <h2>Transactions</h2>
    </div>

    <div class="right-controls">
    <button id="filterBtn" class="icon-btn"><i class="fa-solid fa-filter"></i></button>
    <button id="exportBtn" class="icon-btn"><i class="fa-solid fa-file-export"></i></button>
    <button id="refreshBtn" class="icon-btn"><i class="fa-solid fa-rotate-right"></i></button>
</div>

</section>



    <div class="transactionTableContainer">
        <table class="transactionTable" id="transactionTable">
            <thead>
                <tr><th>Date</th><th>Title</th><th>Category</th><th>Amount</th><th>Actions</th></tr>
            </thead>
            <tbody id="transactionList"></tbody>
        </table>
    </div>

</div>

<div id="filterModal" style="display:none;">
    <div class="filter-modal-overlay"></div>
    <div class="filter-modal-content">
        <h3>Filter Transactions</h3>
        <label>Date From:</label>
        <input type="date" id="filterFrom">

        <label>Date To:</label>
        <input type="date" id="filterTo">

        <label>Category:</label>
        <input type="text" id="filterCategory" placeholder="Category">

        <div class="filter-buttons">
            <button id="applyFilterBtn">Apply</button>
            <button id="resetFilterBtn">Reset</button>
        </div>
    </div>
</div>

<!-- Transaction Details Popup -->
<div id="transactionDetailsPopup" class="popup">
  <div class="popup-content">
    <h3>Transaction Details</h3>
    <p><strong>Title:</strong> <span id="detailTitle"></span></p>
    <p><strong>Amount:</strong> ₹<span id="detailAmount"></span></p>
    <p><strong>Category:</strong> <span id="detailCategory"></span></p>
    <p><strong>Date:</strong> <span id="detailDate"></span></p>
    <button id="closeDetailPopup">Close</button>
  </div>
</div>



<!-- Profile Popup -->
<div id="profilePopup" class="popup">
    <div class="popup-content">
        <h3>My Profile</h3>
        <img id="profileImage" class="profile-img" src="">
        <button id="uploadPhotoBtn" style="background:#04AA6D;color:white;">Upload Photo</button>
        <input type="file" id="uploadPhoto" style="display:none">

        <input type="text" id="profileName" disabled>
        <input type="email" id="profileEmail" disabled>
        <div style="position:relative;">
            <input type="password" id="profilePassword" disabled>
            <i class="fa fa-eye eye-icon" id="toggleProfilePassword"></i>
        </div>

        <button id="editProfileBtn" style="background:#0b7dda;color:white;">Edit</button>
        <button id="saveProfileBtn" style="display:none;background:#04AA6D;color:white;">Save</button>
        <button id="closeProfile" style="background:#f44336;color:white;">Close</button>
    </div>
</div>

<div id="transactionPopup" class="popup">
  <div class="popup-content">
    <h3 id="popupTitle">Add Transaction</h3>
    
    <input type="text" id="title" placeholder="Title (Income / Expense)">
    <span class="error-msg" id="errorTitle"></span>
    
    <input type="number" id="amount" placeholder="Amount">
    <span class="error-msg" id="errorAmount"></span>
    
    <input type="text" id="category" placeholder="Category (Food, Salary)">
    <span class="error-msg" id="errorCategory"></span>
    
    <input type="date" id="date">
    <span class="error-msg" id="errorDate"></span>
    
    <button id="saveTransactionBtn">Save</button>
    <button id="cancelPopupBtn" style="background:#f44336;color:white;">Cancel</button>
  </div>
</div>


<script>
$(document).ready(function() {

    let currentUserEmail = localStorage.getItem("loggedInUser");
    if(!currentUserEmail) { window.location.href="index.html"; }

    let users = JSON.parse(localStorage.getItem("users")) || [];
    let user = users.find(u => u.email === currentUserEmail);
    $("#welcomeUser").text(user.name);

    let transactions = JSON.parse(localStorage.getItem("transactions_" + currentUserEmail)) || [];
    let editIndex = null;

    function loadTransactions() {
        $("#transactionList").empty();
        transactions.forEach((tr, index) => {
            $("#transactionList").append(`
    <tr data-index="${index}">
        <td>${tr.date}</td>
        <td>${tr.title}</td>
        <td>${tr.category}</td>
        <td class="${tr.title.toLowerCase()==='income'?'amount-positive':'amount-negative'}">₹${tr.amount}</td>
        <td>
            <button class="edit-btn" onclick="editTransaction(${index})">Edit</button>
            <button class="delete-btn" onclick="deleteTransaction(${index})">Delete</button>
        </td>
    </tr>
`);
        });
        calculateSummary();
    }
// Toggle details row on click (except buttons)
$(document).on("click", "#transactionList tr", function(e){
    if($(e.target).is("button")) return; // Ignore button clicks

    let index = $(this).data("index");
    let tr = transactions[index];

    // Check if next row is already detail row
    if($(this).next().hasClass("detail-row")) {
        $(this).next().remove(); // hide details if already open
        return;
    }

    // Remove any other open detail rows
    $(".detail-row").remove();

    // Append a new row for details
    $(this).after(`
        <tr class="detail-row">
            <td colspan="5" style="background:#f9f9f9; text-align:left; padding:12px;">
                <strong>Title:</strong> ${tr.title} <br>
                <strong>Amount:</strong> ₹${tr.amount} <br>
                <strong>Category:</strong> ${tr.category} <br>
                <strong>Date:</strong> ${tr.date} <br>
                <strong>Description:</strong> ${tr.description || 'No extra description'}
            </td>
        </tr>
    `);
});

$("#closeDetailPopup").click(() => $("#transactionDetailsPopup").fadeOut(200));

    function calculateSummary() {
        let income = 0, expense = 0;
        transactions.forEach(tr => {
            if(tr.title.toLowerCase()==="income") income += Number(tr.amount);
            else expense += Number(tr.amount);
        });
        $("#totalIncome").text(income);
        $("#totalExpense").text(expense);
        $("#balance").text(income-expense);
    }

    $("#addTransactionBtn").click(function(){
        $("#popupTitle").text("Add Transaction");
        editIndex = null;
        $("#title,#amount,#category,#date").val("");
        $("#transactionPopup").show();
    });


   $("#saveTransactionBtn").click(function() {
    // Get values
    let title = $("#title").val().trim();
    let amount = $("#amount").val().trim();
    let category = $("#category").val().trim();
    let date = $("#date").val();

    // Clear previous error messages
    $(".error-msg").text("");

    let isValid = true;

    // Validation
    if(title === "") {
        $("#errorTitle").text("Title is required.");
        isValid = false;
    }
    if(amount === "") {
        $("#errorAmount").text("Amount is required.");
        isValid = false;
    } else if(isNaN(amount) || Number(amount) <= 0) {
        $("#errorAmount").text("Amount must be a positive number.");
        isValid = false;
    }
    if(category === "") {
        $("#errorCategory").text("Category is required.");
        isValid = false;
    }
    if(date === "") {
        $("#errorDate").text("Date is required.");
        isValid = false;
    }

    if(!isValid) return; // Stop if validation fails

    let obj = { title, amount, category, date };

    if(editIndex !== null) transactions[editIndex] = obj;
    else transactions.push(obj);

    localStorage.setItem("transactions_" + currentUserEmail, JSON.stringify(transactions));
    $("#transactionPopup").hide();
    loadTransactions();
});


    window.editTransaction = function(i){
        editIndex = i;
        let tr = transactions[i];
        $("#title").val(tr.title);
        $("#amount").val(tr.amount);
        $("#category").val(tr.category);
        $("#date").val(tr.date);
        $("#popupTitle").text("Edit Transaction");
        $("#transactionPopup").show();
    };

    window.deleteTransaction = function(i){
        transactions.splice(i,1);
        localStorage.setItem("transactions_" + currentUserEmail, JSON.stringify(transactions));
        loadTransactions();
    };

    $("#cancelPopupBtn").click(() => $("#transactionPopup").hide());

    // Profile
    $("#profileBtn").click(() => {
        $("#profileImage").attr("src", user.photo || "");
        $("#profileName").val(user.name);
        $("#profileEmail").val(user.email);
        $("#profilePassword").val(user.password);
        $("#profilePopup").show();
    });

    $("#toggleProfilePassword").click(() =>{
        let input=$("#profilePassword");
        input.attr("type", input.attr("type")==="password"?"text":"password");
    });

    $("#editProfileBtn").click(function(){
        $("#profileName,#profilePassword").prop("disabled", false);
        $("#saveProfileBtn").show();
    });

    $("#saveProfileBtn").click(function(){
        user.name = $("#profileName").val();
        user.password = $("#profilePassword").val();
        localStorage.setItem("users",JSON.stringify(users));
        location.reload();
    });

    $("#uploadPhotoBtn").click(()=> $("#uploadPhoto").click());

    $("#uploadPhoto").change(function(e){
        let r=new FileReader();
        r.onload=function(){ user.photo=r.result; localStorage.setItem("users",JSON.stringify(users)); $("#profileImage").attr("src",r.result); }
        r.readAsDataURL(this.files[0]);
    });

    $("#closeProfile").click(()=> $("#profilePopup").hide());

    $("#logoutBtn").click(() => { localStorage.removeItem("loggedInUser"); window.location.href="index.html"; });

    $("#exportJsonBtn").click(function(){
        let blob = new Blob([JSON.stringify(transactions)], { type: "application/json" });
        saveAs(blob, "transactions.json");
    });

    $("#exportExcelBtn").click(function(){
        let sheet = XLSX.utils.json_to_sheet(transactions);
        let book = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(book, sheet, "Transactions");
        XLSX.writeFile(book, "transactions.xlsx");
    });

    loadTransactions();
});
// Show modal on filter icon click
$("#filterBtn").click(function() {
    $("#filterModal").fadeIn(200);
});

// Hide modal if click outside content
$(".filter-modal-overlay").click(function() {
    $("#filterModal").fadeOut(200);
});


$("#applyFilterBtn").click(function() {
    let fromDate = $("#filterFrom").val();
    let toDate = $("#filterTo").val();
    let category = $("#filterCategory").val().toLowerCase();

    $("#transactionTable tbody tr").each(function() {
        let trDate = $(this).find("td:nth-child(1)").text();
        let trCategory = $(this).find("td:nth-child(3)").text().toLowerCase();
        let show = true;

        if (fromDate && trDate < fromDate) show = false;
        if (toDate && trDate > toDate) show = false;
        if (category && !trCategory.includes(category)) show = false;

        $(this).toggle(show);
    });

    $("#filterModal").fadeOut(200);
});

$("#resetFilterBtn").click(function() {
    $("#filterFrom, #filterTo, #filterCategory").val("");
    $("#transactionTable tbody tr").show();
    $("#filterModal").fadeOut(200);
});


// ========== REFRESH TABLE ==========
$("#refreshBtn").click(function () {
    location.reload();
});

// ========== PRINT TABLE ==========
$("#printBtn").click(function () {
    window.print();
});

// ========== EXPORT CSV USING jQuery ==========
$("#exportBtn").click(function () {
    let table = $("#transactionTable");
    let rows = table.find("tr");
    let tbodyRows = table.find("tbody tr");

    // Check if there are any transactions
    if (tbodyRows.length === 0) {
        // Replace table body with a single row showing "No transactions present"
        $("#transactionList").html(`
            <tr>
                <td colspan="5" style="text-align:center; color: #555; font-style: italic;">
                    No transactions present
                </td>
            </tr>
        `);
        return; // Stop export
    }

    let csv = [];
    rows.each(function () {
        let row = [];
        $(this).find("th, td").each(function () {
            row.push($(this).text().trim());
        });
        csv.push(row.join(","));
    });

    let csvString = csv.join("\n");
    let fileName = `Transactions_${new Date().toISOString().slice(0,10)}.csv`;
    let blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });

    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
});



</script>

</body>
</html>
